{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-1">üìä Analytics Dashboard</h2>
                            <p class="mb-0">Comprehensive insights into adaptive learning performance</p>
                            <small class="opacity-75" id="tab-info">
                                <!-- Tab info will be inserted here -->
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <button onclick="refreshAnalytics()" class="btn btn-light btn-sm me-2">
                                <i class="fas fa-sync-alt"></i> Refresh Analytics Data
                            </button>
                            <a href="/admin/dashboard?token={{ token }}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="analytics-status">
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                        <div>Loading analytics data...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-info text-white summary-card">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h3 id="total-sessions">0</h3>
                    <p class="mb-0">Total Sessions</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white summary-card">
                <div class="card-body text-center">
                    <i class="fas fa-bullseye fa-2x mb-2"></i>
                    <h3 id="avg-accuracy">--</h3>
                    <p class="mb-0">Average Accuracy</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white summary-card">
                <div class="card-body text-center">
                    <i class="fas fa-question-circle fa-2x mb-2"></i>
                    <h3 id="total-questions">0</h3>
                    <p class="mb-0">Questions Served</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white summary-card">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 id="avg-time">--</h3>
                    <p class="mb-0">Average Time</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card analytics-card">
                <div class="card-header">
                    <h5 class="mb-0">üìà Learning Curves Comparison</h5>
                    <small class="text-muted">Ability progression over time for different sessions</small>
                </div>
                <div class="card-body">
                    <div id="learning-curves-chart" class="chart-container">
                        <div class="loading-placeholder">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p>Loading learning curves...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card analytics-card">
                <div class="card-header">
                    <h5 class="mb-0">üéØ Accuracy Distribution</h5>
                    <small class="text-muted">Performance Distribution</small>
                </div>
                <div class="card-body">
                    <div id="accuracy-distribution-chart" class="chart-container">
                        <div class="loading-placeholder">
                            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                            <p>Loading accuracy distribution...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Details Table with Pagination -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìã Session Details</h5>
                    <small class="text-muted">Detailed breakdown of adaptive exam sessions</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="sessions-table" class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Session ID</th>
                                    <th>Questions</th>
                                    <th>Accuracy</th>
                                    <th>Score</th>
                                    <th>Avg Time</th>
                                    <th>Start Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Loading session data...</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Pagination Controls -->
                        <div id="session-pagination" class="mt-3 text-center">
                            <!-- Pagination buttons will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üì§ Research Data Export</h5>
                    <small class="text-muted">Export data for academic analysis and publication</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <button onclick="exportCSV()" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-file-csv fa-lg mb-2"></i><br>
                                <strong>Export CSV Data</strong><br>
                                <small>Session data in spreadsheet format</small>
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button onclick="exportStatistics()" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-chart-bar fa-lg mb-2"></i><br>
                                <strong>Export Statistics</strong><br>
                                <small>Comprehensive statistical analysis</small>
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button onclick="exportCharts()" class="btn btn-info btn-lg w-100">
                                <i class="fas fa-chart-pie fa-lg mb-2"></i><br>
                                <strong>Export Charts</strong><br>
                                <small>Chart data for visualization tools</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global pagination variables
const ROWS_PER_PAGE = 10;
let allSessions = [];
let currentPage = 1;

class AnalyticsDashboard {
    constructor() {
        this.initializeDashboard();
        this.checkTabStatus();
    }
    
    async initializeDashboard() {
        try {
            await this.loadDashboardData();
        } catch (error) {
            console.error('Dashboard initialization error:', error);
            this.showError('Failed to initialize analytics dashboard');
        }
    }
    
    async checkTabStatus() {
        try {
            const token = new URLSearchParams(window.location.search).get('token');
            const response = await fetch(`/api/tab_status?token=${token}`);
            const data = await response.json();
            
            document.getElementById('tab-info').innerHTML = `
                Tab Session: Active | Total Tabs: ${data.active_tabs}
            `;
        } catch (error) {
            console.log('Tab status check failed:', error);
        }
    }
    
    async loadDashboardData() {
        try {
            const token = new URLSearchParams(window.location.search).get('token');
            const response = await fetch(`/api/analytics/dashboard_data?token=${token}`);
            const data = await response.json();
            
            console.log('Analytics data received:', data);
            
            if (data.status === 'success') {
                this.displaySuccessMessage(data);
                this.updateSummaryCards(data.summary || {});
                
                // Store sessions for pagination
                allSessions = data.sessions || [];
                allSessions.reverse();
                currentPage = 1;
                
                // Initialize pagination
                this.renderPagination();
                this.displayPage(1);
                
                this.createAllCharts(data);
            } else {
                this.showWaitingMessage(data.error || 'No analytics data available');
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            this.showError('Network error occurred while loading analytics data');
        }
    }
    
    displaySuccessMessage(data) {
        const statusElement = document.getElementById('analytics-status');
        const sessionCount = data.sessions ? data.sessions.length : 0;
        
        statusElement.innerHTML = `
            <div class="alert alert-success">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                    <div>
                        <h6 class="mb-1">‚úÖ Analytics Data Loaded Successfully</h6>
                        <p class="mb-0">Found ${sessionCount} adaptive exam sessions for analysis</p>
                        <small class="text-muted">Last updated: ${data.last_updated || 'now'}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    updateSummaryCards(summary) {
        console.log('Updating summary cards with:', summary);
        
        const elements = {
            'total-sessions': summary.total_sessions || 0,
            'avg-accuracy': summary.avg_accuracy ? summary.avg_accuracy + '%' : '--',
            'total-questions': summary.total_questions_served || 0,
            'avg-time': summary.avg_time ? summary.avg_time + 's' : '--'
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                element.style.animation = 'none';
                setTimeout(() => element.style.animation = 'pulse 0.5s ease-in-out', 10);
            }
        });
    }
    
    renderPagination() {
  const totalPages = Math.ceil(allSessions.length / ROWS_PER_PAGE);
  const container = document.getElementById('session-pagination');
  if (!container || totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  let html = '';
  if (currentPage > 1) {
    html += `<button class="btn btn-sm btn-outline-primary me-1" onclick="gotoPage(${currentPage-1})">Previous</button>`;
  }
  html += `<button class="btn btn-sm btn-primary me-1">${currentPage}</button>`;
  if (currentPage < totalPages) {
    html += `<button class="btn btn-sm btn-outline-primary me-1" onclick="gotoPage(${currentPage+1})">Next</button>`;
  }
  container.innerHTML = html;
}

displayPage(page) {
  currentPage = page;
  const start = (page - 1) * ROWS_PER_PAGE;
  const pageSessions = allSessions.slice(start, start + ROWS_PER_PAGE);
  this.populateSessionsTable(pageSessions);
  this.renderPagination();
}

    
    populateSessionsTable(sessions) {
        const tbody = document.querySelector('#sessions-table tbody');
        tbody.innerHTML = '';
        
        if (sessions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No session data available</td></tr>';
            return;
        }
        
        sessions.forEach(session => {
            const row = tbody.insertRow();
            const accuracyClass = this.getAccuracyClass(session.accuracy);
            
            row.innerHTML = `
                <td><code>...${String(session.session_id).slice(-8)}</code></td>
                <td><span class="badge bg-secondary">${session.total_questions || 'N/A'}</span></td>
                <td><span class="badge ${accuracyClass}">${session.accuracy || 0}%</span></td>
                <td>${session.score || 0}</td>
                <td>${session.avg_time || 0}s</td>
                <td><small>${session.start_time || 'N/A'}</small></td>
                <td><span class="badge bg-success">${session.status || 'completed'}</span></td>
            `;
        });
    }
    
    getAccuracyClass(accuracy) {
        if (accuracy >= 80) return 'bg-success';
        if (accuracy >= 60) return 'bg-info';
        if (accuracy >= 40) return 'bg-warning';
        return 'bg-danger';
    }
    
    createAllCharts(data) {
        this.createLearningCurvesChart(data.sessions || []);
        this.createAccuracyDistribution(data.sessions || []);
    }
    
    createLearningCurvesChart(sessions) {
        const chartElement = document.getElementById('learning-curves-chart');
        
        if (sessions.length === 0) {
            chartElement.innerHTML = this.getNoDataMessage('No session data available for learning curves');
            return;
        }
        
        let chartHtml = `
            <div class="learning-curves-container">
                <h6 class="text-center mb-3">Session Performance Progression</h6>
                <div class="row justify-content-center">
        `;
        
        // ‚úÖ FIXED: Show ALL sessions instead of just 6
const displaySessions = sessions.length > 32 ? sessions.slice(26, 32) : sessions;
displaySessions.forEach((session, index) => {

            const color = this.getAccuracyColor(session.accuracy);
            const height = Math.max(20, (session.accuracy / 100) * 120);
            
            chartHtml += `
                <div class="col-2 text-center">
                    <div class="progress-vertical mb-2" style="height: 120px;">
                        <div class="progress-bar-vertical bg-${color}" 
                             style="height: ${height}px;" 
                             title="${session.accuracy}% accuracy"></div>
                    </div>
                    <div class="session-info">
                        <div class="fw-bold">${session.accuracy}%</div>
                        <small class="text-muted">Session ${index + 1}</small>
                    </div>
                </div>
            `;
        });
        
        chartHtml += `
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">Performance progression across ${sessions.length} adaptive sessions</small>
                </div>
            </div>
        `;
        
        chartElement.innerHTML = chartHtml;
    }
    
    createAccuracyDistribution(sessions) {
        const chartElement = document.getElementById('accuracy-distribution-chart');
        
        if (sessions.length === 0) {
            chartElement.innerHTML = this.getNoDataMessage('No session data available for accuracy distribution');
            return;
        }
        
        let excellent = 0, good = 0, average = 0, poor = 0;
        
        sessions.forEach(session => {
            if (session.accuracy >= 80) excellent++;
            else if (session.accuracy >= 60) good++;
            else if (session.accuracy >= 40) average++;
            else poor++;
        });
        
        const total = sessions.length;
        
        chartElement.innerHTML = `
            <div class="performance-distribution">
                <h6 class="text-center mb-3">Performance Distribution</h6>
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="card border-success performance-card h-100">
                            <div class="card-body p-3">
                                <div class="display-6 text-success fw-bold">${excellent}</div>
                                <div class="small fw-bold">Excellent</div>
                                <div class="text-muted small">(80%+ accuracy)</div>
                                <div class="badge bg-success mt-1">${total > 0 ? Math.round((excellent/total)*100) : 0}% of all sessions</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="card border-info performance-card h-100">
                            <div class="card-body p-3">
                                <div class="display-6 text-info fw-bold">${good}</div>
                                <div class="small fw-bold">Good</div>
                                <div class="text-muted small">(60-79% accuracy)</div>
                                <div class="badge bg-info mt-1">${total > 0 ? Math.round((good/total)*100) : 0}% of all sessions</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card border-warning performance-card h-100">
                            <div class="card-body p-3">
                                <div class="display-6 text-warning fw-bold">${average}</div>
                                <div class="small fw-bold">Average</div>
                                <div class="text-muted small">(40-59% accuracy)</div>
                                <div class="badge bg-warning mt-1">${total > 0 ? Math.round((average/total)*100) : 0}% of all sessions</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card border-danger performance-card h-100">
                            <div class="card-body p-3">
                                <div class="display-6 text-danger fw-bold">${poor}</div>
                                <div class="small fw-bold">Poor</div>
                                <div class="text-muted small">(<40% accuracy)</div>
                                <div class="badge bg-danger mt-1">${total > 0 ? Math.round((poor/total)*100) : 0}% of all sessions</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">Total: ${total} adaptive exam sessions analyzed</small>
                </div>
            </div>
        `;
    }
    
    getAccuracyColor(accuracy) {
        if (accuracy >= 80) return 'success';
        if (accuracy >= 60) return 'info';
        if (accuracy >= 40) return 'warning';
        return 'danger';
    }
    
    getNoDataMessage(message) {
        return `
            <div class="text-center text-muted p-4">
                <i class="fas fa-chart-line fa-3x mb-3"></i>
                <p>${message}</p>
                <small>Data will appear here once students complete adaptive exams</small>
            </div>
        `;
    }
    
    showWaitingMessage(message) {
        document.getElementById('analytics-status').innerHTML = `
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock fa-2x me-3 text-warning"></i>
                    <div>
                        <h6 class="mb-1">‚è≥ Analytics Dashboard - Waiting for Data</h6>
                        <p class="mb-0">${message}</p>
                    </div>
                </div>
                <hr>
                <div class="row mt-3">
                    <div class="col-md-8">
                        <strong>Analytics data will populate when:</strong>
                        <ul class="mt-2">
                            <li>Students take adaptive exams from their dashboard</li>
                            <li>Each student completes 5-10 questions per session</li>
                            <li>Multiple sessions are completed for comparison</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-users fa-3x text-muted mb-2"></i>
                            <p class="small text-muted">Monitor this page as admin to see analytics as they're generated</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    showError(message) {
        document.getElementById('analytics-status').innerHTML = `
            <div class="alert alert-danger">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3 text-danger"></i>
                    <div>
                        <h6 class="mb-1">‚ùå Analytics Dashboard Error</h6>
                        <p class="mb-0">${message}</p>
                    </div>
                </div>
            </div>
        `;
    }
}

// üîß FIXED: Frontend analytics display consistency

function updateAnalyticsDashboard() {
    // Fetch consistent data from fixed endpoint
    fetch('/api/admin/dashboard_stats')
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // üéØ UPDATE ALL SESSION DISPLAYS CONSISTENTLY
            
            // Main dashboard stats
            document.getElementById('totalSessions').textContent = data.total_sessions;
            document.getElementById('totalQuestions').textContent = data.total_questions;
            document.getElementById('totalUsers').textContent = data.total_users;
            
            // Separate regular vs adaptive if needed
            document.getElementById('regularExams').textContent = data.total_regular_exams;
            document.getElementById('adaptiveSessions').textContent = data.total_adaptive_sessions;
            
            console.log('‚úÖ Analytics updated:', {
                total_sessions: data.total_sessions,
                regular_exams: data.total_regular_exams,
                adaptive_sessions: data.total_adaptive_sessions
            });
        }
    })
    .catch(error => {
        console.error('‚ùå Analytics update failed:', error);
    });
}

// Update on page load
document.addEventListener('DOMContentLoaded', updateAnalyticsDashboard);

// Auto-refresh every 30 seconds
setInterval(updateAnalyticsDashboard, 30000);


// Global function for pagination
function gotoPage(page) {
    window.dashboard.displayPage(page);
}

// Export functions
function exportCSV() {
    window.open('/api/export/sessions_csv', '_blank');
}

function exportStatistics() {
    window.open('/api/export/statistics', '_blank');
}

function exportCharts() {
    window.open('/api/export/charts_data', '_blank');
}

function refreshAnalytics() {
    location.reload();
}
function gotoPage(page) {
  window.dashboard.displayPage(page);
}


// Initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.dashboard = new AnalyticsDashboard();
});
</script>

<style>
.summary-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.summary-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.analytics-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.chart-container {
    min-height: 300px;
    padding: 20px 0;
}

.progress-vertical {
    background-color: #e9ecef;
    border-radius: 10px;
    position: relative;
    display: flex;
    align-items: end;
    justify-content: center;
}

.progress-bar-vertical {
    width: 30px;
    border-radius: 10px;
    transition: height 0.8s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

#session-pagination .btn {
    min-width: 40px;
}
</style>
{% endblock %}
