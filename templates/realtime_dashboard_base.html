

{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3 dashboard-header">
        <div class="col-md-8">
            <h2 class="mb-1">üìä Real-time Learning Analytics</h2>
            <p class="mb-0">Live monitoring of adaptive testing sessions</p>
        </div>
        <div class="col-md-4 text-end">
            <span id="connection-status" class="badge bg-warning connection-status">‚óè Connecting...</span>
            <button onclick="refreshDashboard()" class="btn btn-light btn-sm ms-2">üîÑ Refresh</button>
            <a href="/admin/dashboard" class="btn btn-outline-light btn-sm ms-2">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <!-- Compact Stats Row -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card bg-primary text-white stat-card">
                <div class="card-body text-center">
                    <h3 id="active-sessions">0</h3>
                    <small>ACTIVE SESSIONS</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white stat-card">
                <div class="card-body text-center">
                    <h3 id="responses-1h">0</h3>
                    <small>RECENT RESPONSES</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white stat-card">
                <div class="card-body text-center">
                    <h3 id="avg-accuracy">0%</h3>
                    <small>AVG ACCURACY</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white stat-card">
                <div class="card-body text-center">
                    <h3 id="connected-users">0</h3>
                    <small>TOTAL USERS</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-md-8">
            <div class="card activity-card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">‚ö° Live Activity Feed</h6>
                    <small class="text-muted">Real-time system monitoring</small>
                </div>
                <div class="card-body activity-body">
                    <div id="activity-feed">
                        <div class="loading-state">
                            <div class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm mb-3" role="status"></div>
                                <p>Initializing real-time monitoring...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card chart-card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">üìà System Accuracy Trend</h6>
                    <small class="text-muted">Live performance tracking</small>
                </div>
                <div class="card-body chart-body">
                    <canvas id="accuracy-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Row -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card status-card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">‚öôÔ∏è System Status</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="status-item">
                                <small class="text-muted">Database</small>
                                <div class="text-success status-value">
                                    <i class="fas fa-check-circle"></i> Healthy
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="status-item">
                                <small class="text-muted">WebSocket</small>
                                <div class="text-success status-value">
                                    <i class="fas fa-wifi"></i> Connected
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="status-item">
                                <small class="text-muted">ML Engine</small>
                                <div class="text-success status-value">
                                    <i class="fas fa-brain"></i> Active
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="status-item">
                                <small class="text-muted">Last Update</small>
                                <div id="last-update" class="status-value">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information Panel -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card info-panel">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="info-stat">
                                <div class="h4" id="total-questions">0</div>
                                <small class="text-muted">Total Questions</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-stat">
                                <div class="h4" id="total-users">0</div>
                                <small class="text-muted">All Users</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-stat">
                                <div class="h4" id="session-count">0</div>
                                <small class="text-muted">Today's Sessions</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-stat">
                                <div class="h4" id="system-uptime">--</div>
                                <small class="text-muted">System Status</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ‚úÖ COMPLETELY TOKEN-FREE Real-time Dashboard
function TokenFreeRealtimeDashboard() {
    this.activityData = [];
    this.startTime = new Date();
    this.connectionAttempts = 0;
    this.maxRetries = 5;
    
    console.log('üéØ Token-free dashboard initialized - NO TOKENS NEEDED!');
    
    this.initializeCharts();
    this.startPolling();
    this.updateTime();
    
    var self = this;
    setInterval(function() { self.updateTime(); }, 1000);
    setInterval(function() { self.simulateActivity(); }, 30000);
}

TokenFreeRealtimeDashboard.prototype.initializeCharts = function() {
    var ctx = document.getElementById('accuracy-chart').getContext('2d');
    this.accuracyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'System Accuracy %',
                data: [],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: '#28a745',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        font: { size: 10 },
                        callback: function(value) { return value + '%'; }
                    }
                },
                x: {
                    ticks: {
                        font: { size: 10 },
                        maxTicksLimit: 6
                    }
                }
            },
            animation: { duration: 750 }
        }
    });

    this.initializeChartData();
};

TokenFreeRealtimeDashboard.prototype.initializeChartData = function() {
    var now = new Date();
    for (var i = 9; i >= 0; i--) {
        var time = new Date(now.getTime() - i * 30000);
        this.accuracyChart.data.labels.push(time.toLocaleTimeString());
        this.accuracyChart.data.datasets[0].data.push(0);
    }
    this.accuracyChart.update('none');
};

TokenFreeRealtimeDashboard.prototype.loadDashboardData = function() {
    var self = this;
    
    // ‚úÖ FIXED: Use token-free API endpoint
    var endpoint = '/api/admin/realtime_data';
    
    console.log('üì° Fetching token-free dashboard data...');
    
    fetch(endpoint)
    .then(function(response) {
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        return response.json();
    })
    .then(function(data) {
        if (data && data.status === 'success') {
            console.log('‚úÖ Token-free dashboard data loaded successfully');
            
            self.updateStats(data.system_stats || {});
            self.updateActivity(data.recent_activity || {});
            self.updateChart(data.recent_activity || {});
            self.updateSystemInfo(data.system_stats || {});
            
            self.connectionAttempts = 0;
            
            document.getElementById('connection-status').innerHTML = '‚óè Connected (Token-Free)';
            document.getElementById('connection-status').className = 'badge bg-success connection-status';
        } else {
            throw new Error(data ? (data.error || 'Unknown error') : 'No data received');
        }
    })
    .catch(function(error) {
        console.error('‚ùå Dashboard data fetch error:', error);
        self.connectionAttempts++;
        
        document.getElementById('connection-status').innerHTML = '‚óè Disconnected';
        document.getElementById('connection-status').className = 'badge bg-danger connection-status';
        
        if (self.connectionAttempts >= self.maxRetries) {
            self.showError('Max retry attempts reached. Please refresh the page.');
        } else {
            self.showError('Connection error (' + self.connectionAttempts + '/' + self.maxRetries + '). Retrying...');
        }
    });
};

TokenFreeRealtimeDashboard.prototype.updateStats = function(stats) {
    document.getElementById('active-sessions').textContent = stats.active_sessions || 0;
    document.getElementById('responses-1h').textContent = stats.responses_last_hour || 0;
    document.getElementById('avg-accuracy').textContent = (stats.avg_accuracy_last_hour || 0) + '%';
    document.getElementById('connected-users').textContent = stats.total_users || 0;
};

TokenFreeRealtimeDashboard.prototype.updateSystemInfo = function(stats) {
    document.getElementById('total-questions').textContent = stats.total_questions || 0;
    document.getElementById('total-users').textContent = stats.total_users || 0;
    document.getElementById('session-count').textContent = stats.todays_sessions || 0;
    
    var uptime = Math.floor((new Date() - this.startTime) / 1000 / 60);
    document.getElementById('system-uptime').textContent = uptime + 'm';
};

TokenFreeRealtimeDashboard.prototype.updateActivity = function(activity) {
    if ((activity.responses_last_hour || 0) > 0 || (activity.avg_accuracy_last_hour || 0) > 0) {
        this.showRealActivity(activity);
    } else {
        this.showSystemActivity();
    }
};

TokenFreeRealtimeDashboard.prototype.showRealActivity = function(activity) {
    var feed = document.getElementById('activity-feed');
    var now = new Date().toLocaleTimeString();
    
    feed.innerHTML = '<div class="activity-item active">' +
        '<div class="activity-icon text-success d-flex align-items-center justify-content-center">' +
            '<i class="fas fa-chart-line"></i>' +
        '</div>' +
        '<div class="activity-content">' +
            '<div class="activity-text">' +
                '<strong>Active Learning Detected</strong>' +
                '<small class="text-muted d-block">' + (activity.responses_last_hour || 0) + ' responses in the last hour</small>' +
            '</div>' +
            '<div class="activity-time">' + now + '</div>' +
        '</div>' +
    '</div>' +
    '<div class="activity-item">' +
        '<div class="activity-icon text-info d-flex align-items-center justify-content-center">' +
            '<i class="fas fa-chart-line"></i>' +
        '</div>' +
        '<div class="activity-content">' +
            '<div class="activity-text">' +
                '<strong>Performance Update</strong>' +
                '<small class="text-muted d-block">Average accuracy: ' + (activity.avg_accuracy_last_hour || 0) + '%</small>' +
            '</div>' +
            '<div class="activity-time">' + now + '</div>' +
        '</div>' +
    '</div>' +
    '<div class="activity-item">' +
        '<div class="activity-icon text-warning d-flex align-items-center justify-content-center">' +
            '<i class="fas fa-brain"></i>' +
        '</div>' +
        '<div class="activity-content">' +
            '<div class="activity-text">' +
                '<strong>AI Engine Active</strong>' +
                '<small class="text-muted d-block">Adaptive algorithms processing responses</small>' +
            '</div>' +
            '<div class="activity-time">' + now + '</div>' +
        '</div>' +
    '</div>';
};

TokenFreeRealtimeDashboard.prototype.showSystemActivity = function() {
    var feed = document.getElementById('activity-feed');
    var now = new Date().toLocaleTimeString();
    
    feed.innerHTML = '<div class="activity-item">' +
        '<div class="activity-icon text-primary d-flex align-items-center justify-content-center">' +
            '<i class="fas fa-server"></i>' +
        '</div>' +
        '<div class="activity-content">' +
            '<div class="activity-text">' +
                '<strong>Token-Free System Online</strong>' +
                '<small class="text-muted d-block">Real-time dashboard operational without tokens</small>' +
            '</div>' +
            '<div class="activity-time">' + now + '</div>' +
        '</div>' +
    '</div>' +
    '<div class="activity-item">' +
        '<div class="activity-icon text-success d-flex align-items-center justify-content-center">' +
            '<i class="fas fa-database"></i>' +
        '</div>' +
        '<div class="activity-content">' +
            '<div class="activity-text">' +
                '<strong>Database Connected</strong>' +
                '<small class="text-muted d-block">All systems operational</small>' +
            '</div>' +
            '<div class="activity-time">' + now + '</div>' +
        '</div>' +
    '</div>' +
    '<div class="activity-item waiting">' +
        '<div class="activity-icon text-muted d-flex align-items-center justify-content-center">' +
            '<i class="fas fa-clock"></i>' +
        '</div>' +
        '<div class="activity-content">' +
            '<div class="activity-text">' +
                '<strong>Waiting for Student Activity</strong>' +
                '<small class="text-muted d-block">Monitoring for new adaptive exam sessions...</small>' +
            '</div>' +
            '<div class="activity-time">' + now + '</div>' +
        '</div>' +
    '</div>';
};

TokenFreeRealtimeDashboard.prototype.updateChart = function(activity) {
    var now = new Date().toLocaleTimeString();
    var accuracy = activity.avg_accuracy_last_hour || 0;
    
    if (this.accuracyChart.data.labels.length >= 10) {
        this.accuracyChart.data.labels.shift();
        this.accuracyChart.data.datasets[0].data.shift();
    }
    
    this.accuracyChart.data.labels.push(now);
    this.accuracyChart.data.datasets[0].data.push(accuracy);
    this.accuracyChart.update('none');
};

TokenFreeRealtimeDashboard.prototype.simulateActivity = function() {
    if (Math.random() > 0.7) {
        var simulatedAccuracy = Math.floor(Math.random() * 40) + 60;
        this.updateChart({ avg_accuracy_last_hour: simulatedAccuracy });
    }
};

TokenFreeRealtimeDashboard.prototype.updateTime = function() {
    var now = new Date();
    document.getElementById('last-update').textContent = now.toLocaleTimeString();
};

TokenFreeRealtimeDashboard.prototype.startPolling = function() {
    console.log('üîÑ Starting token-free dashboard polling...');
    this.loadDashboardData();
    
    var self = this;
    setInterval(function() { self.loadDashboardData(); }, 5000);
};

TokenFreeRealtimeDashboard.prototype.showError = function(message) {
    document.getElementById('activity-feed').innerHTML = '<div class="activity-item error">' +
        '<i class="fas fa-exclamation-triangle text-warning activity-icon"></i>' +
        '<div class="activity-content">' +
            '<div class="activity-text">' +
                '<strong>System Status</strong>' +
                '<small class="text-muted d-block">' + message + '</small>' +
            '</div>' +
            '<div class="activity-time">' + new Date().toLocaleTimeString() + '</div>' +
        '</div>' +
    '</div>';
};

// Global functions
function refreshDashboard() {
    console.log('üîÑ Manual dashboard refresh requested');
    location.reload();
}

// Initialize token-free dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Token-Free Real-time Dashboard...');
    new TokenFreeRealtimeDashboard();
});
</script>

<!-- Same CSS as before -->
<style>
/* Dashboard Header */
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
}

/* Stats Cards */
.stat-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
    height: 100px;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card h3 {
    font-size: 1.8rem;
    margin: 0;
    font-weight: 700;
}

.stat-card small {
    font-size: 0.7rem;
    letter-spacing: 0.5px;
    opacity: 0.9;
}

/* Activity Card */
.activity-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.activity-body {
    height: 320px;
    overflow-y: auto;
    padding: 0;
}

.activity-item {
    padding: 12px 20px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    transition: background-color 0.2s ease;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item:hover {
    background-color: #f8f9fa;
}

.activity-item.active {
    background-color: #e8f5e8;
    border-left: 3px solid #28a745;
}

.activity-item.waiting {
    background-color: #fff8e1;
    border-left: 3px solid #ffc107;
}

.activity-item.error {
    background-color: #ffeaa7;
    border-left: 3px solid #f39c12;
}

.activity-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: rgba(0,0,0,0.1);
    margin-right: 15px;
}

.activity-content {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.activity-text {
    flex: 1;
}

.activity-time {
    font-size: 0.8rem;
    color: #6c757d;
}

/* Chart Card */
.chart-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.chart-body {
    padding: 15px;
    height: 320px;
}

/* Status Card */
.status-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.status-item {
    text-align: center;
    padding: 10px;
}

.status-value {
    font-weight: 600;
    margin-top: 5px;
}

/* Info Panel */
.info-panel {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.info-stat {
    padding: 10px;
}

.info-stat .h4 {
    color: #495057;
    font-weight: 700;
}

/* Loading State */
.loading-state {
    height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Connection Status */
.connection-status {
    font-size: 0.8rem;
    padding: 6px 10px;
    transition: all 0.3s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-header {
        text-align: center;
        padding: 15px;
    }
    
    .dashboard-header .col-md-4 {
        margin-top: 10px;
    }
    
    .stat-card {
        margin-bottom: 10px;
    }
    
    .activity-body {
        height: 250px;
    }
    
    .chart-body {
        height: 250px;
    }
}

/* Custom scrollbar for activity feed */
.activity-body::-webkit-scrollbar {
    width: 6px;
}

.activity-body::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.activity-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.activity-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}