{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <!-- Loading Spinner -->
  <div id="loading" class="text-center">
    <div class="spinner-border text-success" role="status"></div>
    <p>Loading Question...</p>
  </div>
  <!-- Question Card -->
  <div id="questionContainer" style="display:none;">
    <div class="card">
      <div class="card-body">
        <h4 id="questionText"></h4>
        <div id="optionsContainer" class="mb-3"></div>
        <button id="submitAnswer" class="btn btn-success" onclick="submitAnswer()">Submit Answer</button>
      </div>
    </div>
  </div>
  <!-- Completion Card -->
  <div id="completionContainer" style="display:none;">
    <div class="card text-center">
      <div class="card-body">
        <h3>Adaptive Exam Completed!</h3>
        <p><strong><span id="finalCorrect"></span></strong> / <span id="finalQuestions"></span> correct</p>
        <p>Accuracy: <span id="finalAccuracy"></span></p>
        <a href="/student/dashboard" class="btn btn-primary">Back to Dashboard</a>
      </div>
    </div>
  </div>
</div>

<script>
    console.log("adaptive_exam.js loaded");
alert("JS loaded");
// State
let currentQuestion, sessionId;
let questionsAnswered = 0, correctAnswers = 0;
const totalQuestions = 10, startTime = Date.now();

// Display question
function displayQuestion(q) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('questionContainer').style.display = '';
  document.getElementById('submitAnswer').disabled = false;
  document.getElementById('questionText').innerHTML =
    `<strong>Q${questionsAnswered+1}:</strong> ${q.question_text}`;
  document.getElementById('optionsContainer').innerHTML =
    ['a','b','c','d'].map(letter =>
      `<div class="form-check">
         <input class="form-check-input" type="radio" name="answer" value="${letter}">
         <label class="form-check-label"><strong>${letter.toUpperCase()}</strong>. ${q['option_'+letter]}</label>
       </div>`
    ).join('');
}

// Load next question
function loadNextQuestion() {
  if (questionsAnswered >= totalQuestions) return showCompletion();
  fetch('/api/next_adaptive_question', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    session_id: sessionId,          // value is sessionId
    questions_answered: questionsAnswered
  })
})


  .then(r=>r.json())
  .then(d => {
    if (d.success && d.question) {
      currentQuestion = d.question;
      sessionId = d.session_id;
      displayQuestion(d.question);
    } else if (d.complete) {
      showCompletion();
    } else {
      throw 'Failed to load';
    }
  })
  .catch(e => alert(e));
}

// Submit answer
function submitAnswer() {
  const sel = document.querySelector('input[name="answer"]:checked');
  if (!sel) return alert('Select an answer.');
  document.getElementById('submitAnswer').disabled = true;
  const elapsed = Math.floor((Date.now()-startTime)/1000);
  fetch('/api/submit_adaptive_response', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    question_id: currentQuestion.id,
    selected_option: sel.value,
    time_taken: elapsed,
    session_id: sessionId      // NOT session_id as a variable!
  })
})

  .then(r=>r.json())
  .then(d => {
    if (!d.success) throw d.error||'Submit failed';
    questionsAnswered++;
    if (d.is_correct) correctAnswers++;
    loadNextQuestion();
  })
  .catch(err => {
    alert(err);
    document.getElementById('submitAnswer').disabled = false;
  });
}

// Show completion and record
function showCompletion() {
  document.getElementById('questionContainer').style.display = 'none';
  document.getElementById('completionContainer').style.display = '';
  document.getElementById('finalQuestions').textContent = questionsAnswered;
  document.getElementById('finalCorrect').textContent = correctAnswers;
  document.getElementById('finalAccuracy').textContent =
    ((correctAnswers/questionsAnswered)*100).toFixed(1)+'%';
  const elapsed = Math.floor((Date.now()-startTime)/1000);
  fetch('/api/adaptive/complete', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      session_id,
      questions_answered: questionsAnswered,
      correct_answers: correctAnswers,
      time_taken: elapsed
    })
  });
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loading').style.display = '';
  loadNextQuestion();
});

var session_id = "{{ session_id }}";
</script>
{% endblock %}
