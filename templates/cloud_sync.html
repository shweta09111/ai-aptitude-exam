{% extends "base.html" %}

{% block title %}Cloud Sync - Admin Panel{% endblock %}

{% block content %}
<!-- Version: 2.0 - Fixed loading modals and status display -->
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-cloud-upload-alt me-2"></i>Cloud Synchronization</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Cloud Sync</li>
                </ol>
            </nav>
        </div>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>

    <!-- Status Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card {% if cloud_available %}bg-success{% else %}bg-danger{% endif %} text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Cloud Status</h5>
                            <h6 class="mb-0">{% if cloud_available %}Connected{% else %}Disconnected{% endif %}</h6>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas {% if cloud_available %}fa-cloud-upload-alt{% else %}fa-cloud-times{% endif %} fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Local Questions</h5>
                            <h3 class="mb-0" id="localCount">{{ sync_status.local_questions }}</h3>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-database fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Cloud Questions</h5>
                            <h3 class="mb-0" id="cloudCount">{{ sync_status.cloud_questions }}</h3>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-cloud fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-0">Last Sync</h5>
                            <h6 class="mb-0" id="lastSync">{{ sync_status.last_sync or 'Never' }}</h6>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-sync-alt fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not cloud_available %}
    <!-- Setup Instructions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Cloud Sync Not Available</h4>
                <p>To enable cloud synchronization, you need to set up Supabase credentials:</p>
                <ol>
                    <li>Create a free Supabase project at <a href="https://supabase.com" target="_blank" class="alert-link">https://supabase.com</a></li>
                    <li>Get your project URL and anon key from the project settings</li>
                    <li>Add them to your <code>.env</code> file:
                        <pre class="mt-2 p-2 bg-light text-dark rounded">SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key_here</pre>
                    </li>
                    <li>Create a <code>questions</code> table in your Supabase project with the required columns</li>
                    <li>Restart the application</li>
                </ol>
                <button type="button" class="btn btn-outline-warning" id="testConnectionBtn">
                    <i class="fas fa-plug me-2"></i>Test Connection
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if cloud_available %}
    <!-- Background Sync Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Automatic Background Sync</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <p class="mb-2"><strong>‚úÖ Background sync is enabled!</strong></p>
                            <p class="mb-0">Your questions are automatically synced to Supabase cloud every <strong>12 hours</strong>.</p>
                            <p class="text-muted small mb-0">Next automatic sync: <span id="nextSyncTime" class="badge bg-info">Loading...</span></p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-success btn-lg" id="manualSyncBtn">
                                <i class="fas fa-sync-alt me-2"></i>Sync Now
                            </button>
                        </div>
                    </div>
                    <div id="syncProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%">
                                Syncing questions to cloud...
                            </div>
                        </div>
                        <p class="text-muted small mt-2">This may take a few minutes. Check server logs for progress.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Operations -->
    <div class="row mb-4">
        <!-- Upload to Cloud -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload to Cloud</h5>
                </div>
                <div class="card-body">
                    <p>Upload local questions to Supabase cloud database.</p>
                    <div class="mb-3">
                        <label for="uploadLimit" class="form-label">Limit (optional)</label>
                        <input type="number" class="form-control" id="uploadLimit" placeholder="All questions" min="1">
                        <div class="form-text">Leave empty to upload all local questions</div>
                    </div>
                    <button type="button" class="btn btn-primary w-100" id="uploadBtn">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Upload Questions
                    </button>
                </div>
            </div>
        </div>

        <!-- Download from Cloud -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-cloud-download-alt me-2"></i>Download from Cloud</h5>
                </div>
                <div class="card-body">
                    <p>Download questions from Supabase to local database.</p>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="updateLocal" checked>
                            <label class="form-check-label" for="updateLocal">
                                Update local database
                            </label>
                        </div>
                        <div class="form-text">Uncheck to preview only</div>
                    </div>
                    <button type="button" class="btn btn-info w-100" id="downloadBtn">
                        <i class="fas fa-cloud-download-alt me-2"></i>Download Questions
                    </button>
                </div>
            </div>
        </div>

        <!-- Bidirectional Sync -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-sync-alt me-2"></i>Full Sync</h5>
                </div>
                <div class="card-body">
                    <p>Perform bidirectional synchronization between local and cloud.</p>
                    <div class="mb-3">
                        <select class="form-select" id="syncDirection">
                            <option value="bidirectional">Bidirectional (both ways)</option>
                            <option value="upload">Upload only</option>
                            <option value="download">Download only</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-success w-100" id="syncBtn">
                        <i class="fas fa-sync-alt me-2"></i>Synchronize
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Connection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-vial me-2"></i>Test Connection</h5>
                </div>
                <div class="card-body">
                    <p>Test the connection to your Supabase cloud database.</p>
                    <button type="button" class="btn btn-warning" id="testConnectionBtn">
                        <i class="fas fa-plug me-2"></i>Test Connection
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sync Results -->
    <div class="row" id="resultsSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Sync Results</h5>
                </div>
                <div class="card-body">
                    <div id="syncResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync History -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Sync History</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Sync history tracking will be implemented in future updates.
                        Current status shows real-time information about your local and cloud databases.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loadingTitle">Processing...</h5>
                <p class="text-muted mb-0" id="loadingMessage">Please wait while we process your request.</p>
            </div>
        </div>
    </div>
</div>

<script>
// Cache buster - Force reload if old version (v2.1 - 2025-10-11 22:20)
const SCRIPT_VERSION = '2.1.20251011';
const cachedVersion = sessionStorage.getItem('cloudSyncVersion');
if (cachedVersion !== SCRIPT_VERSION) {
    sessionStorage.setItem('cloudSyncVersion', SCRIPT_VERSION);
    if (cachedVersion) {  // Only reload if there was a previous version
        location.reload(true);  // Hard reload
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const uploadBtn = document.getElementById('uploadBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const syncBtn = document.getElementById('syncBtn');
    const manualSyncBtn = document.getElementById('manualSyncBtn');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

    // Manual sync button (new - uses standalone script)
    if (manualSyncBtn) {
        manualSyncBtn.addEventListener('click', function() {
            const syncProgress = document.getElementById('syncProgress');
            syncProgress.style.display = 'block';
            manualSyncBtn.disabled = true;
            
            fetch('/api/cloud_sync/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    showAlert('success', '‚úÖ ' + result.message);
                    setTimeout(() => {
                        syncProgress.style.display = 'none';
                        manualSyncBtn.disabled = false;
                        refreshStatus();
                    }, 3000);
                } else {
                    showAlert('danger', '‚ùå ' + (result.error || 'Sync failed'));
                    syncProgress.style.display = 'none';
                    manualSyncBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', '‚ùå Network error occurred during sync');
                syncProgress.style.display = 'none';
                manualSyncBtn.disabled = false;
            });
        });
    }

    // Upload to cloud
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
            const limit = document.getElementById('uploadLimit').value;
            const data = limit ? { limit: parseInt(limit) } : {};
            
            showLoading('Uploading to Cloud', 'Uploading questions to Supabase...');
            uploadBtn.disabled = true;
            
            fetch('/api/cloud_sync/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                uploadBtn.disabled = false;
                
                if (result.status === 'success') {
                    showAlert('success', '‚úÖ Upload started! This may take a few minutes. Check server logs for progress.');
                    // Wait for sync to complete (15 seconds) then refresh
                    setTimeout(() => {
                        refreshStatus();
                        checkSyncLogs();
                    }, 15000);
                } else {
                    showAlert('danger', '‚ùå ' + (result.error || 'Upload failed'));
                }
            })
            .catch(error => {
                hideLoading();
                uploadBtn.disabled = false;
                console.error('Error:', error);
                showAlert('danger', '‚ùå Network error occurred during upload');
            });
        });
    }

    // Download from cloud
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            const updateLocal = document.getElementById('updateLocal').checked;
            const data = { update_local: updateLocal };
            
            showLoading('Downloading from Cloud', updateLocal ? 'Downloading and updating local database...' : 'Downloading questions (preview)...');
            downloadBtn.disabled = true;
            
            fetch('/api/cloud_sync/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                downloadBtn.disabled = false;
                
                if (result.status === 'success') {
                    const message = `‚úÖ Download complete!\nüì• Downloaded: ${result.downloaded || 0} questions\nüíæ Updated in DB: ${result.updated || 0} questions`;
                    showAlert('success', message.replace(/\n/g, '<br>'));
                    displayResults(result, 'success');
                    refreshStatus();
                } else {
                    showAlert('danger', '‚ùå ' + (result.error || 'Download failed'));
                    displayResults(result, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                downloadBtn.disabled = false;
                console.error('Error:', error);
                showAlert('danger', '‚ùå Network error occurred during download');
            });
        });
    }

    // Full sync
    if (syncBtn) {
        syncBtn.addEventListener('click', function() {
            const direction = document.getElementById('syncDirection').value;
            const data = { direction: direction };
            
            showLoading('Synchronizing', 'Performing bidirectional sync...');
            syncBtn.disabled = true;
            
            fetch('/api/cloud_sync/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                syncBtn.disabled = false;
                
                if (result.status === 'success') {
                    showAlert('success', '‚úÖ Sync started! This may take a few minutes. Check server logs for progress.');
                    // Wait for sync to complete (15 seconds) then refresh
                    setTimeout(() => {
                        refreshStatus();
                        checkSyncLogs();
                    }, 15000);
                } else {
                    showAlert('danger', '‚ùå ' + (result.error || 'Sync failed'));
                }
            })
            .catch(error => {
                hideLoading();
                syncBtn.disabled = false;
                console.error('Error:', error);
                showAlert('danger', '‚ùå Network error occurred during sync');
            });
        });
    }

    // Test connection
    if (testConnectionBtn) {
        testConnectionBtn.addEventListener('click', function() {
            showLoading('Testing Connection', 'Testing Supabase connection...');
            testConnectionBtn.disabled = true;
            
            fetch('/api/cloud_sync/test', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                testConnectionBtn.disabled = false;
                
                if (result.status === 'success') {
                    const message = `‚úÖ Connection successful!\nüìä Cloud questions: ${result.cloud_questions || 0}\nüîó Supabase is working properly`;
                    showAlert('success', message.replace(/\n/g, '<br>'));
                    displayResults(result, 'success');
                } else {
                    showAlert('danger', '‚ùå Connection failed: ' + (result.error || 'Unknown error'));
                    displayResults(result, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                testConnectionBtn.disabled = false;
                console.error('Error:', error);
                showAlert('danger', '‚ùå Network error occurred during connection test');
            });
        });
    }

    function checkSyncLogs() {
        // Show a message to check logs for detailed results
        const resultsSection = document.getElementById('resultsSection');
        const resultsDiv = document.getElementById('syncResults');
        
        resultsDiv.innerHTML = `
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle me-2"></i>Sync in Progress</h5>
                <p class="mb-2">The synchronization is running in the background.</p>
                <p class="mb-0"><strong>To see detailed results:</strong></p>
                <ol class="mb-0 mt-2">
                    <li>Check your terminal/server logs for real-time progress</li>
                    <li>Look for messages starting with "üìä", "‚úÖ", "‚è≠Ô∏è", "‚ùå"</li>
                    <li>Status cards above will update automatically when sync completes</li>
                </ol>
            </div>
        `;
        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    function showLoading(title, message) {
        document.getElementById('loadingTitle').textContent = title;
        document.getElementById('loadingMessage').textContent = message;
        loadingModal.show();
    }

    function hideLoading() {
        loadingModal.hide();
    }

    function displayResults(result, type) {
        const resultsSection = document.getElementById('resultsSection');
        const resultsDiv = document.getElementById('syncResults');
        
        let html = '';

        if (type === 'success') {
            html = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>' + 
                   (result.message || 'Operation completed successfully') + '</div>';

            // Create stats cards
            const stats = [];
            if (result.uploaded !== undefined) stats.push({ label: 'Uploaded', value: result.uploaded, icon: 'upload' });
            if (result.downloaded !== undefined) stats.push({ label: 'Downloaded', value: result.downloaded, icon: 'download' });
            if (result.updated !== undefined) stats.push({ label: 'Updated in DB', value: result.updated, icon: 'database' });
            if (result.cloud_questions !== undefined) stats.push({ label: 'Cloud Questions', value: result.cloud_questions, icon: 'cloud' });
            if (result.failed !== undefined && result.failed > 0) stats.push({ label: 'Failed', value: result.failed, icon: 'times-circle', color: 'danger' });

            if (stats.length > 0) {
                html += '<div class="row mt-3">';
                stats.forEach(stat => {
                    const color = stat.color || 'primary';
                    html += `
                        <div class="col-md-${12 / Math.min(stats.length, 4)}">
                            <div class="card border-${color} mb-3">
                                <div class="card-body text-center">
                                    <i class="fas fa-${stat.icon} fa-2x text-${color} mb-2"></i>
                                    <h3 class="mb-1">${stat.value}</h3>
                                    <small class="text-muted">${stat.label}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Add test result
            if (result.test_result) {
                html += `<div class="alert alert-info mt-3"><strong>Test Result:</strong> ${result.test_result}</div>`;
            }

            // Add note
            if (result.note) {
                html += `<div class="alert alert-warning mt-3"><i class="fas fa-info-circle me-2"></i>${result.note}</div>`;
            }

        } else {
            html = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>' + 
                   (result.error || 'Operation failed') + '</div>';
                   
            if (result.required_env) {
                html += '<p><strong>Required Environment Variables:</strong></p><ul>';
                result.required_env.forEach(env => {
                    html += `<li><code>${env}</code></li>`;
                });
                html += '</ul>';
            }
        }

        resultsDiv.innerHTML = html;
        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function refreshStatus() {
        fetch('/api/cloud_sync/status')
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    const status = result.sync_status;
                    document.getElementById('localCount').textContent = status.local_questions;
                    document.getElementById('cloudCount').textContent = status.cloud_questions;
                }
            })
            .catch(error => {
                console.error('Error refreshing status:', error);
            });
    }

    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Auto-refresh status every 30 seconds
    setInterval(refreshStatus, 30000);
});
</script>
{% endblock %}